---
title: "PROYECTO 1"
author: "Grupo 4"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(haven)
library(janitor)
library(fs)
library(ggplot2)
library(labelled)
library(knitr)
library(kableExtra)
```


```{r}
unir_spss <- function(ruta_carpeta) {
  

  archivos <- dir_ls(ruta_carpeta, glob = "*.sav")
  
  if(length(archivos) == 0) {
    stop("¡Error! No encontré ningún archivo .sav en esa carpeta.")
  }
  
  message(paste("Se encontraron", length(archivos), "archivos. Iniciando unión segura..."))
  

  leer_y_normalizar <- function(archivo) {

    message(paste("  -> Procesando:", path_file(archivo)))
    
    read_sav(archivo) %>%

      clean_names() %>% 

      zap_labels() %>% 

      mutate(across(everything(), as.character))
  }
  

  df_unido <- map_dfr(archivos, leer_y_normalizar, .id = "origen_archivo")
  
  message("Unión completada. Restaurando tipos de datos...")
  
  #
  df_final <- df_unido %>%
    type_convert(col_types = cols()) 
    
  return(df_final)
}
```

```{r}
df_defunciones <- unir_spss("./Defunciones")
```

# Avances del proyecto 1

## Descripción General del conjunto de datos.

### Cantidad de variables y observaciones
```{r dimensiones_del_conjunto_de_datos}
# Numero de filas y columnas
total_observaciones <- nrow(df_defunciones)
total_variables <- ncol(df_defunciones)

cat("Cantidad de Observaciones (Filas):", format(total_observaciones, big.mark=","), "\n")
cat("Cantidad de Variables (Columnas):", total_variables, "\n")
```
El conjunto de datos consolidado, que abarca el período de 2012 a 2022, presenta una estructura robusta para el análisis de minería. Se identificaron un total de 950,793 observaciones; cada fila representa un registro único de defunción procesado por el INE, lo que constituye un volumen de datos estadísticamente significativo para detectar patrones de mortalidad a nivel nacional. En cuanto a la dimensionalidad, el dataset cuenta con 32 variables (columnas). Estos atributos contienen la información multidimensional de cada suceso, integrando datos geográficos, demográficos y médicos necesarios para la segmentación y el modelado predictivo.


### Significado y tipo de cada una de las variables
```{r Significado_y_tipo_de_cada_una_de_las_variables}
# Cargar metadatos originales (usar el primer archivo .sav como referencia)
archivo_ref <- dir_ls("./Defunciones", glob = "*.sav")[1]
datos_ref <- read_sav(archivo_ref) %>% janitor::clean_names()
etiquetas <- var_label(datos_ref)

# Definir lógica para el "Tipo de Variable" (Para que no salga todo como 'texto')
obtener_tipo_real <- function(nombre_var) {
  if (str_detect(nombre_var, "^(edad|anio|mes|dia|cant|total)")) {
    return("Numérico (Discreto)")
  } else if (str_detect(nombre_var, "^(fecha)")) {
    return("Fecha")
  } else {
    return("Categórico (Nominal)")
  }
}

# 3. Crear la Tabla Maestra
tabla_diccionario <- tibble(
  Variable = names(df_defunciones)
) %>%
  mutate(
    # A. Obtener el significado original
    Significado = map_chr(Variable, function(x) {
      lbl <- etiquetas[[x]]
      if (is.null(lbl)) return("Variable de Control / ID") else return(as.character(lbl))
    }),
    
    # B. Definir el tipo de dato lógico para el reporte
    Tipo_Variable = map_chr(Variable, obtener_tipo_real)
  ) %>%
  select(Variable, Tipo_Variable, Significado)

# 4. Mostrar la tabla
kable(tabla_diccionario, 
      caption = "Tabla 1: Diccionario de Variables (Significado y Tipología)",
      align = "l")
```
La tabla anterior presenta la estructura semántica del conjunto de datos consolidado, detallando las 32 variables disponibles tras la extracción de metadatos de los archivos fuente (.sav). Se observa una predominancia de variables categóricas nominales (como sexo, caudef y códigos geográficos) que permitirán la segmentación de la población, complementadas por variables numéricas discretas (como edadif y fechas de ocurrencia) esenciales para el análisis de distribuciones y series temporales. Esta caracterización valida que se cuenta con los atributos demográficos y médicos necesarios.


## Exploración de variables numéricas
```{r limpieza_de_variables_numericas}
df_numerico_final <- df_defunciones %>%
  mutate(
    valor_edad = as.numeric(edadif),
    unidad_tiempo = as.numeric(perdif),
    
    # LÓGICA CORREGIDA:
    edad_calculada = case_when(
      # El código 3 es AÑOS
      unidad_tiempo == 3 ~ valor_edad,
      
      # El código 2 es MESES
      unidad_tiempo == 2 ~ valor_edad / 12,
      
      # El código 1 es DÍAS
      unidad_tiempo == 1 ~ valor_edad / 365.25,
      
      # El 9 es Ignorado/NA
      unidad_tiempo == 9 ~ NA_real_,
      
      TRUE ~ NA_real_
    )
  ) %>%
  filter(!is.na(edad_calculada)) # Quitamos los ignorados
```
Para habilitar el análisis numérico, se implementó un algoritmo de limpieza condicional orientado a unificar la heterogeneidad de las unidades de medida originales (horas, días, meses y años) en una única escala continua de años calendario. El procedimiento transforma la variable edadif basándose en el código temporal perdif: se preservan los valores anuales directos (código 3), se normalizan los meses dividiendo por 12 (código 2) y los días por 365.25 (código 1), filtrando finalmente cualquier registro inconsistente o ignorado para garantizar la validez de los estadísticos descriptivos subsiguientes.


### Medidas de tendencia central, distribución y orden.
```{r Cálculo de Estadísticos (Tendencia Central y Orden)}
tabla_final <- df_numerico_final %>%
  summarise(
    Promedio = mean(edad_calculada),
    Mediana = median(edad_calculada),
    Desviacion = sd(edad_calculada),
    Minimo = min(edad_calculada),
    Maximo = max(edad_calculada),
     # El 25% muere antes de esta edad
    Q1_25 = quantile(edad_calculada, 0.25),
     # El 75% muere antes de esta edad
    Q3_75 = quantile(edad_calculada, 0.75)
  )


# Mostrar la tabla formateada
knitr::kable(tabla_final, digits = 2, caption = "Estadísticos de Edad")
```
El análisis estadístico revela una distribución asimétrica negativa, evidenciada por un promedio de 54.92 años que es inferior a la mediana de 62 años; esta diferencia sugiere que, si bien el punto de equilibrio central se ubica en la adultez mayor, la incidencia de mortalidad en edades tempranas ejerce una fuerte influencia a la baja sobre la media. La variabilidad de los datos es alta, reflejada en una desviación estándar de 28.39 años que abarca un rango biológico completo desde el nacimiento (0 años) hasta una longevidad máxima de 122 años. En cuanto a las medidas de posición, se observa que el primer cuartil se sitúa en 35 años, indicando que el 25% de las defunciones ocurren en la población joven, mientras que el tercer cuartil alcanza los 78 años, lo que confirma que la mayor densidad de fallecimientos se concentra hacia la tercera edad.


##Exploracion de variables categoricas

```{r}
# 1. Definición de Variables
vars_analisis <- c(
  "sexo",    "areag",    "ecidif",   "escodif", 
  "depocu",  "mupocu",   "ocur",                
  "caudef",  "asist",    "cerdef",              
  "getdif",  "ocudif",   "nacdif",              
  "anoreg",  "anoocu",   "perdif"               
)

vars_existentes <- intersect(vars_analisis, names(df_defunciones))

for (var_actual in vars_existentes) {
  
  
  tabla_base <- df_defunciones %>%
    filter(!is.na(.data[[var_actual]])) %>%
    mutate(across(all_of(var_actual), as.character)) %>% 
    count(.data[[var_actual]], sort = TRUE, name = "Frecuencia") %>%
    mutate(Porcentaje = round((Frecuencia / sum(Frecuencia)) * 100, 2))
  
  
  if(nrow(tabla_base) > 12) {
    top_10 <- head(tabla_base, 10)
    resto <- tabla_base %>%
      slice(11:n()) %>%
      summarise(
        Var = paste("OTRAS (", n(), " Categorías)", sep=""),
        Frecuencia = sum(Frecuencia),
        Porcentaje = sum(Porcentaje)
      )
    names(resto)[1] <- var_actual
    tabla_final <- bind_rows(top_10, resto)
  } else {
    tabla_final <- tabla_base
  }
  
  colnames(tabla_final) <- c("Categoría", "Frecuencia (N)", "Porcentaje (%)")
  
  print(
    kable(
      tabla_final, 
      caption = paste("Distribución:", toupper(var_actual)),
      align = "c",
      digits = 2,
      format.args = list(big.mark = ",")
    ) %>%
    # ESTILOS VISUALES:
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
      full_width = FALSE, 
      position = "center",
      font_size = 14
    ) %>%
    row_spec(0, bold = TRUE, color = "white", background = "#2c3e50")
  )
  
  cat("\n\n<br>\n\n") 
}
```

